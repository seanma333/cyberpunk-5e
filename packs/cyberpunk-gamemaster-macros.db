{"folder": "AVyC5AD82a68am6K", "name": "Remove Mod", "type": "script", "author": "35XmDJHnBMPCEkei", "img": "icons/skills/melee/sword-damaged-chipped-green.webp", "scope": "global", "command": "const wait = (delay) => new Promise((resolve) => setTimeout(resolve, delay));\n\nfunction getItemFromActor(actor, itemId) {\n    return actor.items.find(i => i.id === itemId)\n}\n\nfunction getModdedWeaponsFromActor(actor) {\n    return actor.items.filter(i => {\n        if (!i.flags.hasOwnProperty(\"cyberpunk5e\")) return false;\n        if (i.type === \"weapon\" && i.flags.cyberpunk5e.hasOwnProperty(\"mods\")) {\n            return i.flags.cyberpunk5e.mods.length > 0;\n        }\n        return false;\n    });\n}\n\nfunction getAppliedModsFromActor(actor) {\n    return actor.items.filter(i => {\n        if (!i.flags.hasOwnProperty(\"cyberpunk5e\")) return false;\n        if (i.flags.cyberpunk5e.hasOwnProperty(\"modification_props\")) {\n            return i.flags.cyberpunk5e.modification_props.applied_to;\n        }\n    })\n}\n\nfunction updateModSelect(html, actor) {\n    var selectedWeaponId = html.find('[name=\"weaponSelect\"]')[0].value;\n    var selectedWeapon = getItemFromActor(actor, selectedWeaponId);\n    var selectedWeaponMods = selectedWeapon.flags.cyberpunk5e.mods;\n\n    var appliedProps = getAppliedModsFromActor(actor).filter(m => {\n        return m.flags.cyberpunk5e.modification_props.applied_to === selectedWeaponId\n    }).map(m => m.flags.cyberpunk5e.modification_props.prop_name);\n\n\n    var modsToSelect = selectedWeaponMods.filter(m => appliedProps.every(p => m !== p))\n    var modOptions = modsToSelect.map(m => `<option value=\"${m}\">${m[0].toUpperCase()}${m.slice(1)}</option>`)\n\n    modSelect = html.find('[name=\"modSelect\"]')[0];\n    if (modOptions.length > 0) modSelect.removeAttribute(\"disabled\");\n    else modSelect.setAttribute(\"disabled\", \"disabled\");\n    modSelect.innerHTML = modOptions;\n}\n\nasync function addUpdateHandlers(html, actor) {\n    html.find('[name=\"weaponSelect\"]').on(\"change\", function(){updateModSelect(html, actor)});\n}\n\nasync function removeButton(html, actor) {\n    selectedMod = html.find('[name=\"modSelect\"]')[0].value;\n    selectedWeaponId = html.find('[name=\"weaponSelect\"]')[0].value;\n    \n    if (!selectedMod || !selectedWeaponId) return;\n    \n    weapon = getItemFromActor(actor, selectedWeaponId)\n    weaponName = weapon.name.includes('[') ? weapon.name.substring(0, weapon.name.lastIndexOf('[')).trim() : weapon.name;\n    \n    updatedWeaponMods = weapon.flags.cyberpunk5e.mods.filter(m => m !== selectedMod).sort((a, b) => a.localeCompare(b))\n    updatedWeaponName = updatedWeaponMods.length === 0 ? weaponName : `${weaponName} [${updatedWeaponMods.map(m => m[0].toUpperCase() + m.slice(1)).join(', ')}]`\n    \n    weaponUpdates = {\n        'name': updatedWeaponName,\n        'flags.cyberpunk5e.mods': updatedWeaponMods\n    }\n    await weapon.update(weaponUpdates)\n    \n    ChatMessage.create({content: `GM has removed ${selectedMod} from ${weaponName} belonging to ${actor.name}.`})\n}\n\n// Main Code\nvar weapons = getModdedWeaponsFromActor(token.actor);\n\nif (weapons.length == 0) return;\n\nvar appliedMods = getAppliedModsFromActor(token.actor);\nappliedModWeaponIds = appliedMods.map(m => m.flags.cyberpunk5e.modification_props.applied_to)\n\n\nvar filteredWeapons = weapons.filter(w => {\n    weaponMods = w.flags.cyberpunk5e.mods;\n    appliedMods.filter(m => m.flags.cyberpunk5e.modification_props.applied_to === w.id)\n        .forEach(m => {weaponMods = weaponMods.filter(wm => wm !== m.flags.cyberpunk5e.modification_props.prop_name)})\n    return weaponMods.length > 0;\n})\n\nvar weaponOptions = filteredWeapons.map(w => `<option value=${w.id}>${w.name}</option>`)\n    .reduce((r,opt) => r.concat(opt), '<option disabled value selected />');\n\nvar dialogHtml = `\n<div>\n<label>Select weapon:</label>\n<select id=\"weaponSelect\" name=\"weaponSelect\">${weaponOptions}</select>\n</div>\n<div>\n<label>Select mod to remove:</label>\n<select id=\"modSelect\" name=\"modSelect\" disabled></select>\n</div>\n`\n\nvar d = new Dialog({\n  title: \"Remove Mod From Weapon\",\n  content: dialogHtml,\n  buttons: {\n    remove: {\n      label: \"Remove Mod\",\n      callback: (html) => removeButton(html, token.actor)\n    }\n  },\n  default: \"remove\",\n  render: (html) => {\n    addUpdateHandlers(html, token.actor)\n  }\n}).render(true)", "sort": 0, "_id": "IKBOe5yNuam3YA2u", "_stats": {"systemId": "dnd5e", "systemVersion": "2.0.3", "coreVersion": "10.288", "createdTime": 1667965342717, "modifiedTime": 1667965342717, "lastModifiedBy": "35XmDJHnBMPCEkei"}, "ownership": {"default": 0, "35XmDJHnBMPCEkei": 3}, "flags": {}}
